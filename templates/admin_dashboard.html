<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
  :root {
    /* Light theme (default) */
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f1f5f9;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-tertiary: #64748b;
    --accent-primary: #3b82f6;
    --accent-secondary: #8b5cf6;
    --accent-tertiary: #06b6d4;
    --accent-warning: #f59e0b;
    --accent-danger: #ef4444;
    --accent-success: #10b981;
    --border-light: #e2e8f0;
    --border-medium: #cbd5e1;
    --shadow-sm: 0 1px 2px rgba(2,6,23,.05);
    --shadow-md: 0 4px 6px -1px rgba(2,6,23,.1), 0 2px 4px -1px rgba(2,6,23,.06);
    --shadow-lg: 0 10px 15px -3px rgba(2,6,23,.1), 0 4px 6px -2px rgba(2,6,23,.05);
    --shadow-xl: 0 20px 25px -5px rgba(2,6,23,.1), 0 10px 10px -5px rgba(2,6,23,.04);
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 24px;
    --glass: rgba(255,255,255,0.7);
    --glass-border: rgba(255,255,255,0.5);
    --header-height: 80px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  [data-theme="dark"] {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-tertiary: #334155;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-tertiary: #94a3b8;
    --border-light: #334155;
    --border-medium: #475569;
    --glass: rgba(30, 41, 59, 0.7);
    --glass-border: rgba(30, 41, 59, 0.5);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    scroll-behavior: smooth;
  }

  body {
    font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, Helvetica, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    transition: var(--transition);
    overflow-x: hidden;
  }

  /* ===== Header ===== */
  #sds-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    backdrop-filter: blur(10px);
    background: var(--glass);
    border-bottom: 1px solid var(--glass-border);
    box-shadow: var(--shadow-md);
    transform: translateZ(0);
  }

  #sds-header .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: var(--header-height);
    padding: 0 24px;
    max-width: 1400px;
    margin: 0 auto;
  }

  #sds-header .brand {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  #sds-header .logo {
    height: 48px;
    width: auto;
    transition: var(--transition);
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
  }

  #sds-header .logo:hover {
    transform: scale(1.05);
  }

  #sds-header .title {
    font-weight: 800;
    font-size: 22px;
    letter-spacing: 0.5px;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    position: relative;
    padding: 8px 16px;
    border-radius: var(--radius-md);
    transition: var(--transition);
    transform-style: preserve-3d;
    transform: translateZ(0);
  }

  #sds-header .title::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: var(--radius-md);
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    opacity: 0.1;
    transform: translateZ(-10px);
    transition: var(--transition);
  }

  #sds-header .title:hover::before {
    opacity: 0.15;
  }

  .nav-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    height: 40px;
    padding: 0 16px;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
    border: 1px solid transparent;
    background: var(--bg-secondary);
    color: var(--text-primary);
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.7s ease;
  }

  .btn:hover::before {
    left: 100%;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn.link {
    background: transparent;
    border-color: transparent;
    box-shadow: none;
    color: var(--text-secondary);
  }

  .btn.link:hover {
    color: var(--accent-primary);
    background: transparent;
    transform: none;
  }

  .btn.primary {
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    color: white;
    border: none;
    box-shadow: 0 4px 6px rgba(59, 130, 246, 0.25);
  }

  .btn.primary:hover {
    box-shadow: 0 8px 15px rgba(59, 130, 246, 0.35);
    transform: translateY(-2px);
  }

  .btn.icon {
    width: 40px;
    padding: 0;
  }

  .header-spacer {
    height: var(--header-height);
  }

  /* Theme toggle */
  .theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-secondary);
  }

  .theme-toggle:hover {
    background: var(--bg-tertiary);
    color: var(--accent-primary);
  }

  /* Main content */
  .wrap {
    max-width: 1400px;
    margin: 24px auto;
    padding: 0 24px;
    animation: fadeIn 0.5s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* KPI Cards */
  .kpis {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 28px;
  }

  .kpi {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    padding: 24px;
    box-shadow: var(--shadow-md);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border-light);
  }

  .kpi::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 6px;
    height: 100%;
    background: linear-gradient(to bottom, var(--accent-primary), var(--accent-secondary));
  }

  .kpi:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
  }

  .kpi h4 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 12px;
  }

  .kpi .num {
    font-size: 32px;
    font-weight: 800;
    margin-bottom: 8px;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
  }

  .kpi .trend {
    font-size: 12px;
    font-weight: 500;
    color: var(--accent-success);
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .kpi .trend.muted {
    color: var(--text-tertiary);
  }

  /* Grid layout */
  .grid-2 {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 24px;
    margin-bottom: 28px;
  }

  /* Cards */
  .card {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    padding: 24px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-light);
    transition: var(--transition);
    animation: cardSlide 0.4s ease-out;
  }

  @keyframes cardSlide {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .card:hover {
    box-shadow: var(--shadow-lg);
  }

  .card h3 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card h3 i {
    color: var(--accent-primary);
  }

  /* Flash messages */
  .flash {
    margin: 16px 0;
    padding: 12px 16px;
    border-radius: var(--radius-md);
    background: rgba(239, 68, 68, 0.1);
    color: var(--accent-danger);
    border: 1px solid rgba(239, 68, 68, 0.2);
    display: flex;
    align-items: center;
    gap: 10px;
    animation: shake 0.5s ease;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-5px); }
    40%, 80% { transform: translateX(5px); }
  }

  /* Toolbar */
  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
  }

  /* Search */
  .search {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    padding: 0 16px;
    height: 44px;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
  }

  .search:focus-within {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  }

  .search input {
    border: 0;
    outline: 0;
    width: 240px;
    font: inherit;
    background: transparent;
    color: var(--text-primary);
  }

  .search input::placeholder {
    color: var(--text-tertiary);
  }

  /* Chips */
  .chip {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    border-radius: 100px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
  }

  .chip:hover {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
    transform: translateY(-2px);
  }

  .chip.active {
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    color: white;
    border-color: transparent;
    box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
  }

  /* Table */
  .table-wrap {
    overflow: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
    background: var(--bg-secondary);
    box-shadow: var(--shadow-sm);
  }

  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 860px;
  }

  thead th {
    background: var(--bg-tertiary);
    padding: 16px;
    text-align: left;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-light);
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    transition: var(--transition);
    position: sticky;
    top: 0;
  }

  thead th:hover {
    background: var(--border-light);
  }

  tbody td {
    padding: 16px;
    border-bottom: 1px solid var(--border-light);
    font-size: 14px;
    color: var(--text-primary);
    transition: var(--transition);
  }

  tbody tr {
    transition: var(--transition);
  }

  tbody tr:hover {
    background: var(--bg-tertiary);
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  /* Role pill */
  .role-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 100px;
    background: var(--bg-tertiary);
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
  }

  /* Action row */
  .act-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  /* Mobile list */
  @media (max-width: 860px) {
    .table-wrap {
      display: none;
    }
    
    .list-cards {
      display: grid;
      gap: 16px;
    }
    
    .list-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
    }
    
    .list-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .list-card .row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin: 8px 0;
      flex-wrap: wrap;
    }
    
    .list-card .tag {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 100px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }
  }

  /* Menu & Dropdown */
  .menu {
    position: relative;
  }

  .dropdown {
    position: absolute;
    right: 0;
    top: calc(100% + 8px);
    min-width: 220px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-xl);
    display: none;
    z-index: 100;
    animation: dropdownFade 0.2s ease-out;
  }

  @keyframes dropdownFade {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .dropdown.open {
    display: block;
  }

  .dropdown ul {
    list-style: none;
    margin: 0;
    padding: 8px;
  }

  .dropdown li {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition);
  }

  .dropdown li:hover {
    background: var(--bg-tertiary);
  }

  /* Pager */
  .pager {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .pager button {
    height: 36px;
    padding: 0 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition);
    color: var(--text-secondary);
  }

  .pager button:hover {
    background: var(--bg-tertiary);
    color: var(--accent-primary);
  }

  .pager select {
    height: 36px;
    padding: 0 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    color: var(--text-primary);
  }

  /* Footer */
  footer {
    margin: 40px auto;
    max-width: 1400px;
    padding: 0 24px;
    color: var(--text-tertiary);
    font-size: 13px;
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
  }

  /* Sheet (Modal) */
  .sheet {
    position: fixed;
    inset: 0;
    z-index: 2000;
    display: none;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    animation: fadeIn 0.3s ease;
  }

  .sheet.open {
    display: block;
  }

  .sheet-panel {
    position: absolute;
    inset: 0;
    background: var(--bg-secondary);
    overflow: auto;
    animation: panelSlide 0.3s ease;
  }

  @keyframes panelSlide {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .sheet-inner {
    max-width: 1000px;
    margin: 0 auto;
    padding: 24px;
  }

  .sheet-head {
    position: sticky;
    top: 0;
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-light);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 10;
  }

  .sheet-title {
    font-weight: 700;
    font-size: 20px;
    color: var(--text-primary);
  }

  .sheet-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  /* Form */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 16px;
    margin-top: 24px;
  }

  .field, .select, .textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    color: var(--text-primary);
    font: inherit;
    transition: var(--transition);
  }

  .field:focus, .select:focus, .textarea:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  }

  .textarea {
    resize: vertical;
    min-height: 120px;
  }

  .label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 8px;
  }

  .hint {
    font-size: 12px;
    color: var(--text-tertiary);
    margin-top: 6px;
  }

  .col-3 { grid-column: span 3; }
  .col-4 { grid-column: span 4; }
  .col-6 { grid-column: span 6; }
  .col-8 { grid-column: span 8; }
  .col-9 { grid-column: span 9; }
  .col-12 { grid-column: span 12; }

  .inline {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  /* Switch */
  .switch {
    position: relative;
    width: 50px;
    height: 26px;
    background: var(--border-medium);
    border-radius: 100px;
    cursor: pointer;
    transition: var(--transition);
  }

  .switch input {
    display: none;
  }

  .switch .thumb {
    position: absolute;
    top: 3px;
    left: 3px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: var(--transition);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .switch input:checked + .thumb {
    transform: translateX(24px);
    background: white;
  }

  .switch input:checked {
    background: var(--accent-primary);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .grid-2 {
      grid-template-columns: 1fr;
    }
    
    .col-6, .col-4, .col-3 {
      grid-column: span 6;
    }
  }

  @media (max-width: 768px) {
    .wrap {
      padding: 0 16px;
    }
    
    .kpis {
      grid-template-columns: 1fr;
    }
    
    .toolbar {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .search input {
      width: 180px;
    }
    
    .col-6, .col-4, .col-3 {
      grid-column: span 12;
    }
    
    #sds-header .header {
      padding: 0 16px;
    }
    
    .nav-actions {
      gap: 8px;
    }
    
    .btn {
      padding: 0 12px;
      font-size: 13px;
    }
    
    .btn.link span {
      display: none;
    }
  }

  @media (max-width: 480px) {
    .sheet-inner {
      padding: 16px;
    }
    
    .form-grid {
      gap: 12px;
    }
  }

  /* Animations */
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* Chart container */
  .chart-container {
    position: relative;
    height: 250px;
    width: 100%;
  }

  /* Loading animation */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(59, 130, 246, 0.3);
    border-radius: 50%;
    border-top-color: var(--accent-primary);
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Parallax elements */
  .parallax-layer {
    transition: transform 0.1s linear;
  }

  /* Scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb {
    background: var(--border-medium);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--text-tertiary);
  }
  </style>
</head>
<body>
  <!-- ===== Header ===== -->
  <section id="sds-header" aria-label="Site header">
    <header class="header">
      <div class="brand">
        <a href="{{ url_for('home') }}" aria-label="Home">
          <img src="{{ url_for('static', filename='Images/logo.png') }}" alt="SDS Logo" class="logo" />
        </a>
        <span class="title">Admin Dashboard</span>
      </div>
      <nav class="nav-actions" aria-label="Primary">
        <a class="btn link" href="{{ url_for('employee_dashboard') }}"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a>
        <a class="btn link" href="{{ url_for('attendance_page') }}"><i class="fas fa-calendar-check"></i> <span>Attendance</span></a>
        <a class="btn link" href="/about"><i class="fas fa-info-circle"></i> <span>About</span></a>
        <button class="btn primary" id="openCreate" type="button" aria-controls="createSheet" aria-haspopup="true"><i class="fas fa-plus"></i> Create Employee</button>
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
          <i class="fas fa-moon"></i>
        </button>
        <a class="btn" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a>
      </nav>
    </header>
    <div class="header-spacer" aria-hidden="true"></div>
  </section>

  <main class="wrap">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash"><i class="fas fa-exclamation-circle"></i> {{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- KPIs -->
    <section class="kpis">
      <div class="kpi">
        <h4><i class="fas fa-users"></i> Total Employees</h4>
        <div class="num">{% if stats is defined %}{{ stats.employees }}{% elif employees is defined %}{{ employees|length }}{% else %}0{% endif %}</div>
        <div class="trend"><i class="fas fa-circle"></i> Live</div>
      </div>
      <div class="kpi">
        <h4><i class="fas fa-user-circle"></i> Faces Registered</h4>
        <div class="num">{% if stats is defined and stats.faces is defined %}{{ stats.faces }}{% else %}-{% endif %}</div>
        <div class="trend muted">via Face Service</div>
      </div>
      <div class="kpi">
        <h4><i class="fas fa-history"></i> Today's Logs</h4>
        <div class="num">{% if stats is defined %}{{ stats.today_logs }}{% else %}-{% endif %}</div>
        <div class="trend"><i class="fas fa-check-circle"></i> Up-to-date</div>
      </div>
      <div class="kpi">
        <h4><i class="fas fa-user-shield"></i> Admin Accounts</h4>
        <div class="num">
          {% set admins = 0 %}
          {% if employees is defined %}
            {% for p, u in employees %}
              {% if u.role == 'ADMIN' %}
                {% set admins = admins + 1 %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {{ admins }}
        </div>
        <div class="trend muted">role = ADMIN</div>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid-2">
      <div class="card">
        <h3><i class="fas fa-chart-pie"></i> Role Distribution</h3>
        <div class="chart-container">
          <canvas id="rolesChart"></canvas>
        </div>
      </div>
      <div class="card">
        <h3><i class="fas fa-chart-line"></i> New Hires (Last 6 Months)</h3>
        <div class="chart-container">
          <canvas id="hiresChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Employees table -->
    <section class="card">
      <div class="toolbar">
        <div class="controls">
          <div class="search">
            <i class="fas fa-search"></i>
            <input id="filter" placeholder="Search employees... ( / )" />
          </div>
          <button class="chip" data-chip="ALL">All</button>
          <button class="chip" data-chip="ADMIN">Admin</button>
          <button class="chip" data-chip="MANAGER">Manager</button>
          <button class="chip" data-chip="BDE">BDE</button>
          <button class="chip" data-chip="FPC">FPC</button>
        </div>
        <div class="controls">
          <div class="menu" id="colMenu">
            <button class="btn" aria-haspopup="true"><i class="fas fa-columns"></i> Columns</button>
            <div class="dropdown" role="menu" aria-label="Toggle columns">
              <ul>
                <li><input type="checkbox" data-col="1" checked> Name</li>
                <li><input type="checkbox" data-col="2" checked> Email</li>
                <li><input type="checkbox" data-col="3" checked> Role</li>
                <li><input type="checkbox" data-col="4" checked> Designation</li>
                <li><input type="checkbox" data-col="5" checked> Department</li>
                <li><input type="checkbox" data-col="6" checked> Created</li>
                <li><input type="checkbox" data-col="7" checked> Actions</li>
              </ul>
            </div>
          </div>
          <button class="btn" id="exportCsv"><i class="fas fa-file-export"></i> Export CSV</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="empTable" aria-label="Employees">
          <thead>
            <tr>
              <th data-sort="text">Name</th>
              <th data-sort="text">Email</th>
              <th data-sort="text">Role</th>
              <th data-sort="text">Designation</th>
              <th data-sort="text">Department</th>
              <th data-sort="date">Created</th>
              <th data-sort="text">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if employees is defined and employees %}
              {% for profile, user in employees %}
                <tr data-role="{{ user.role }}" data-created="{{ user.created_at.strftime('%Y-%m') if user.created_at else '' }}">
                  <td>{{ profile.name }}</td>
                  <td>{{ user.email }}</td>
                  <td><span class="role-pill">{{ user.role }}</span></td>
                  <td>{{ profile.designation or "-" }}</td>
                  <td>{{ profile.department or "-" }}</td>
                  <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '-' }}</td>
                  <td>
                    <div class="act-row">
                      <form method="post" action="{{ url_for('admin_delete_user') }}" onsubmit="return confirm('Delete this account? This cannot be undone.');">
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                        <button class="btn icon" type="submit" title="Delete"><i class="fas fa-trash"></i></button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="7" class="muted" style="padding:24px; text-align: center;">No employees yet.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <!-- Mobile mirror -->
      <div class="list-cards" id="mobileList" aria-live="polite"></div>

      <div class="toolbar" style="margin-top:16px">
        <div class="muted" id="rowsInfo">—</div>
        <div class="pager">
          <button id="prevPage"><i class="fas fa-chevron-left"></i> Prev</button>
          <div class="muted" id="pageInfo">1 / 1</div>
          <button id="nextPage">Next <i class="fas fa-chevron-right"></i></button>
          <select id="pageSize" class="select">
            <option>10</option>
            <option>25</option>
            <option selected>50</option>
            <option>100</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Attendance Export -->
    <section class="card">
      <h3><i class="fas fa-file-export"></i> Daily Attendance Export</h3>
      <div class="toolbar" style="gap:12px">
        <div class="controls">
          <label class="label" for="attDate" style="margin:0 8px 0 0">Pick date</label>
          <input id="attDate" type="date" class="field" style="width:200px" />
          <button class="btn" id="btnExportAttendance"><i class="fas fa-download"></i> Download CSV</button>
          <span class="muted">Excel-compatible CSV will be generated from provided logs.</span>
        </div>
      </div>
    </section>

    <!-- Tips -->
    <section class="card">
      <h3><i class="fas fa-lightbulb"></i> Tips & Shortcuts</h3>
      <ul style="margin:8px 0 0 24px; color:var(--text-secondary); line-height:1.8">
        <li>Press <b>/</b> to focus search.</li>
        <li>Click column headers to sort. Use chips to filter by role.</li>
        <li>Use <b>Columns</b> to hide/show columns. Export CSVs for Employees or Attendance.</li>
      </ul>
    </section>
  </main>

  <!-- ===== Full-page Create Employee Sheet ===== -->
  <section id="createSheet" class="sheet" aria-hidden="true">
    <!-- Sliding panel -->
    <div class="sheet-panel">
      <div class="sheet-head">
        <div class="sheet-title">Create Employee</div>
        <div class="sheet-actions">
          <button class="btn" id="closeCreate" type="button"><i class="fas fa-times"></i> Close</button>
          <button class="btn primary" form="createForm" type="submit"><i class="fas fa-save"></i> Save Employee</button>
        </div>
      </div>

      <div class="sheet-inner">
        <form id="createForm" class="form-grid" method="post" action="{{ url_for('admin_create_user') }}" enctype="multipart/form-data" autocomplete="off">
          <!-- PERSONAL -->
          <div class="col-4">
            <label class="label">Name *</label>
            <input class="field" name="name" id="f_name" placeholder="Full name" required />
          </div>
          <div class="col-4">
            <label class="label">Email *</label>
            <input class="field" name="email" id="f_email" placeholder="e.g., john.doe@company.com" required />
            <div class="hint">Auto-suggested from name. You can edit.</div>
          </div>
          <div class="col-4">
            <label class="label">Avatar</label>
            <input class="field" type="file" name="avatar" accept="image/*" />
          </div>

          <div class="col-4">
            <label class="label">Phone *</label>
            <input class="field" name="phone" placeholder="Phone number" required />
          </div>
          <div class="col-4">
            <label class="label">Country *</label>
            <input class="field" name="country" placeholder="Country" required />
          </div>
          <div class="col-4">
            <label class="label">Joining Date *</label>
            <input class="field" type="date" name="joining_date" required />
          </div>

          <div class="col-4">
            <label class="label">Date of Birth</label>
            <input class="field" type="date" name="dob" />
          </div>
          <div class="col-4">
            <label class="label">Blood Group</label>
            <select class="select" name="blood_group">
              <option value="">Choose One</option><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
            </select>
          </div>
          <div class="col-4">
            <label class="label">Gross Salary *</label>
            <input class="field" name="salary" placeholder="Salary" required />
          </div>

          <div class="col-4">
            <label class="label">Branch *</label>
            <select class="select" name="branch" id="f_branch" required>
              <option value="">Choose One</option>
              <option>Assam/Guwahati (HO)</option>
              <option>Meghalaya</option>
              <option>Tripura</option>
              <option>Manipur</option>
            </select>
          </div>
          <div class="col-4">
            <label class="label">Aadhar No</label>
            <input class="field" name="aadhar" />
          </div>
          <div class="col-4">
            <label class="label">Employee UAN No</label>
            <input class="field" name="uan" />
          </div>

          <div class="col-4">
            <label class="label">Employee Type</label>
            <select class="select" name="emp_type">
              <option value="">Choose One</option>
              <option>Full-time</option><option>Part-time</option><option>On Probation</option><option>Contract</option>
            </select>
          </div>
          <div class="col-4">
            <label class="label">Skill Level</label>
            <select class="select" name="skill_level">
              <option value="">Choose One</option>
              <option>Fresher</option><option>Intermediate</option><option>Senior</option>
            </select>
          </div>

          <div class="col-4">
            <label class="label">Parents Senior Citizen? *</label>
            <div class="inline">
              <label class="inline"><input type="radio" name="parents_senior" value="Yes" required/> Yes</label>
              <label class="inline"><input type="radio" name="parents_senior" value="No" /> No</label>
            </div>
          </div>

          <div class="col-4">
            <label class="label">Number of Children</label>
            <input class="field" type="number" name="children" min="0" />
          </div>
          <div class="col-4">
            <label class="label">Payment Mode *</label>
            <select class="select" name="payment_mode" required>
              <option>Cash</option><option>Bank Transfer</option><option>UPI</option>
            </select>
          </div>
          <div class="col-4">
            <label class="label">Previous Designation</label>
            <input class="field" name="prev_designation" placeholder="e.g., Manager" />
          </div>

          <div class="col-4">
            <label class="label">Prev. Employment Tenure End Date</label>
            <input class="field" type="date" name="prev_tenure_end" />
          </div>

          <!-- PASSWORD -->
          <div class="col-4">
            <label class="label">Password *</label>
            <div class="inline" style="gap:12px">
              <label class="inline"><input type="radio" name="pwd_mode" value="default" checked /> <span>Default (12345678)</span></label>
              <label class="inline"><input type="radio" name="pwd_mode" value="generated" /> <span>Generate strong</span></label>
              <label class="inline"><input type="radio" name="pwd_mode" value="custom" /> <span>Custom</span></label>
            </div>
            <div class="inline" style="margin-top:8px">
              <input class="field" name="password" id="f_password" placeholder="Password" value="12345678" />
              <button class="btn" id="btnGenPass" type="button" title="Generate">Generate</button>
              <span class="chip" id="pwdStrength">strength: —</span>
            </div>
          </div>

          <!-- ORG ROLE -->
          <div class="col-4">
            <label class="label">Role *</label>
            <select class="select" name="role" required>
              <option>ADMIN</option><option>MANAGER</option><option>BDE</option><option>FPC</option><option>EMP</option>
            </select>
          </div>
          <div class="col-4">
            <label class="label">Designation *</label>
            <input class="field" name="designation" placeholder="e.g., Manager" required />
          </div>
          <div class="col-4">
            <label class="label">Department *</label>
            <input class="field" name="department" placeholder="e.g., Human Resource" required />
          </div>
          <div class="col-4">
            <label class="label">Shift *</label>
            <select class="select" name="shift" required>
              <option>General</option><option>Morning</option><option>Night</option>
            </select>
          </div>
          <div class="col-4">
            <label class="label">Gender *</label>
            <select class="select" name="gender" required>
              <option>Male</option><option>Female</option><option>Other</option>
            </select>
          </div>
          <div class="col-8">
            <label class="label">Address</label>
            <textarea class="textarea" name="address" placeholder="Address"></textarea>
          </div>

          <div class="col-4">
            <label class="label">Religion</label>
            <select class="select" name="religion">
              <option value="">Choose One</option><option>Hindu</option><option>Buddhism</option><option>Muslim</option><option>Christian</option><option>Sikh</option><option>Other</option>
            </select>
          </div>
          <div class="col-4">
            <label class="label">Marital Status</label>
            <select class="select" name="marital">
              <option value="">Choose One</option><option>Single</option><option>Married</option><option>Divorced</option>
            </select>
          </div>
          <div class="col-4">
            <label class="label">Speak Language</label>
            <input class="field" name="language" placeholder="e.g., English, Hindi" />
          </div>
          <div class="col-4">
            <label class="label">PAN No</label>
            <input class="field" name="pan" />
          </div>

          <div class="col-4">
            <label class="label">Disability Level *</label>
            <select class="select" name="disability" required>
              <option>No Disability</option><option>Low</option><option>Moderate</option><option>High</option>
            </select>
          </div>
          <div class="col-4">
            <label class="label">Employee ESIC IP</label>
            <input class="field" name="esic" />
          </div>
          <div class="col-4">
            <label class="label">Employment Status</label>
            <select class="select" name="emp_status">
              <option value="">Choose One</option><option>Active</option><option>On Leave</option><option>Resigned</option>
            </select>
          </div>
          <div class="col-4">
            <label class="label">Father's Name</label>
            <input class="field" name="father" />
          </div>
          <div class="col-4">
            <label class="label">Dependent Disability Level *</label>
            <select class="select" name="dep_disability" required>
              <option>No Disability</option><option>Low</option><option>Moderate</option><option>High</option>
            </select>
          </div>
          <div class="col-4">
            <label class="label">No. of Children in Hostel</label>
            <input class="field" type="number" name="hostel_children" min="0" />
          </div>
          <div class="col-6">
            <label class="label">Previous Employer Name</label>
            <input class="field" name="prev_employer" />
          </div>
          <div class="col-3">
            <label class="label">Prev. Employment From</label>
            <input class="field" type="date" name="prev_tenure_from" />
          </div>
          <div class="col-3">
            <label class="label">Prev. Employment To</label>
            <input class="field" type="date" name="prev_tenure_to" />
          </div>
          <div class="col-3">
            <label class="label">Employee ID</label>
            <input class="field" name="emp_code" placeholder="Auto / Custom" />
          </div>

          <div class="col-12" style="margin-top:16px">
            <div class="inline">
              <label class="label" style="margin:0">Send credentials by email</label>
              <label class="switch" title="If ON, backend should email credentials">
                <input type="checkbox" name="email_creds" checked><span class="thumb"></span>
              </label>
            </div>
            <div class="hint">Backend tip: when checked, send a welcome email with the generated password.</div>
          </div>
        </form>
      </div>
    </div>
  </section>

  <footer>
    <div style="display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap">
      <div>© <span id="yr"></span> Company • Admin Dashboard</div>
      <div>Client-side search, sort, and export.</div>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // ===== THEME TOGGLE =====
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = themeToggle.querySelector('i');
      
      // Check for saved theme preference or respect OS preference
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeIcon.classList.replace('fa-moon', 'fa-sun');
      }
      
      themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        if (currentTheme === 'dark') {
          document.documentElement.removeAttribute('data-theme');
          themeIcon.classList.replace('fa-sun', 'fa-moon');
          localStorage.setItem('theme', 'light');
        } else {
          document.documentElement.setAttribute('data-theme', 'dark');
          themeIcon.classList.replace('fa-moon', 'fa-sun');
          localStorage.setItem('theme', 'dark');
        }
      });

      // ===== HEADER SPACER SYNC =====
      (function(){
        const root = document.documentElement;
        const header = document.querySelector('#sds-header .header');
        const spacer = document.querySelector('.header-spacer');
        
        function sync(){
          if(!header || !spacer) return;
          const h = Math.round(header.getBoundingClientRect().height || 80);
          root.style.setProperty('--header-height', h + 'px');
          spacer.style.height = h + 'px';
        }
        
        sync();
        window.addEventListener('resize', sync);
        window.addEventListener('load', sync);
      })();

      // ===== PARALLAX EFFECTS =====
      (function(){
        const header = document.querySelector('#sds-header');
        const title = document.querySelector('#sds-header .title');
        
        if (!header || !title) return;
        
        header.addEventListener('mousemove', (e) => {
          const { left, top, width, height } = header.getBoundingClientRect();
          const x = (e.clientX - left) / width - 0.5;
          const y = (e.clientY - top) / height - 0.5;
          
          title.style.transform = `translateZ(0) rotateY(${x * 5}deg) rotateX(${-y * 5}deg)`;
        });
        
        header.addEventListener('mouseleave', () => {
          title.style.transform = 'translateZ(0)';
        });
      })();

      // ===== OPEN/CLOSE CREATE SHEET =====
      const sheet = document.getElementById('createSheet');
      const openBtn = document.getElementById('openCreate');
      const closeBtn = document.getElementById('closeCreate');

      function sheetToggle(on){
        if(!sheet) return;
        if(on){
          sheet.classList.add('open');
          sheet.setAttribute('aria-hidden','false');
          document.body.style.overflow = 'hidden';
          setTimeout(function(){
            const nm = document.getElementById('f_name');
            if(nm) nm.focus();
          }, 100);
        } else {
          sheet.classList.remove('open');
          sheet.setAttribute('aria-hidden','true');
          document.body.style.overflow = 'auto';
        }
      }
      
      if(openBtn && sheet){
        openBtn.addEventListener('click', function(e){ 
          e.preventDefault(); 
          e.stopPropagation(); 
          sheetToggle(true); 
        });
      }
      
      if(closeBtn){ 
        closeBtn.addEventListener('click', function(e){ 
          e.preventDefault(); 
          sheetToggle(false); 
        }); 
      }

      // Close sheet on ESC or click backdrop
      document.addEventListener('keydown', function(e){
        if(e && e.key === 'Escape' && sheet && sheet.classList.contains('open')) {
          sheetToggle(false);
        }
        if(e && e.key === '/'){
          e.preventDefault(); 
          const filt = document.getElementById('filter'); 
          if(filt) filt.focus(); 
        }
      });
      
      if(sheet){ 
        sheet.addEventListener('click', function(e){ 
          if(e.target === sheet) sheetToggle(false); 
        }); 
      }

      // ===== EMAIL SUGGEST + PASSWORD GEN =====
      const EMAIL_DOMAIN = "{{ company_domain|default('company.com') }}";
      const fName = document.getElementById('f_name');
      const fEmail = document.getElementById('f_email');
      const fPassword = document.getElementById('f_password');
      const btnGenPass = document.getElementById('btnGenPass');
      const pwdStrength = document.getElementById('pwdStrength');

      function slugName(s){ 
        return String(s || '').toLowerCase().trim()
          .replace(/[^a-z\s]/g, '')
          .replace(/\s+/g, ' ')
          .split(' ')
          .filter(Boolean)
          .slice(0, 3)
          .join('.');
      }
      
      function suggestEmail(){ 
        if(!fName || !fEmail) return; 
        const base = slugName(fName.value); 
        if(base) fEmail.value = base + '@' + EMAIL_DOMAIN; 
      }
      
      if(fName) fName.addEventListener('blur', suggestEmail);

      function randomPassword(len){ 
        len = len || 12; 
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%^&*()_+"; 
        let out = ""; 
        for(let i = 0; i < len; i++){ 
          out += chars[Math.floor(Math.random() * chars.length)]; 
        } 
        return out; 
      }
      
      function strength(pw){ 
        pw = String(pw || ''); 
        let s = 0; 
        if(pw.length >= 12) s++; 
        if(/[A-Z]/.test(pw)) s++; 
        if(/[a-z]/.test(pw)) s++; 
        if(/[0-9]/.test(pw)) s++; 
        if(/[^A-Za-z0-9]/.test(pw)) s++; 
        const words = ["very weak", "weak", "fair", "good", "strong", "very strong"]; 
        return words[Math.min(s, 5)]; 
      }
      
      function applyPwdMode(){
        const checked = document.querySelector('input[name="pwd_mode"]:checked');
        const mode = (checked && checked.value) ? checked.value : 'default';
        if(!fPassword) return;
        
        if(mode === 'default'){ 
          fPassword.value = '12345678'; 
          fPassword.readOnly = false; 
        } else if(mode === 'generated'){ 
          fPassword.value = randomPassword(); 
          fPassword.readOnly = false; 
        } else { 
          fPassword.readOnly = false; 
          fPassword.focus(); 
        }
        
        if(pwdStrength) pwdStrength.textContent = 'strength: ' + strength(fPassword.value);
      }
      
      const pwdRadios = document.querySelectorAll('input[name="pwd_mode"]');
      for(let i = 0; i < pwdRadios.length; i++){ 
        pwdRadios[i].addEventListener('change', applyPwdMode); 
      }
      
      if(btnGenPass){ 
        btnGenPass.addEventListener('click', function(){ 
          if(!fPassword) return; 
          fPassword.value = randomPassword(); 
          if(pwdStrength) pwdStrength.textContent = 'strength: ' + strength(fPassword.value); 
        }); 
      }
      
      if(fPassword){ 
        fPassword.addEventListener('input', function(){ 
          if(pwdStrength) pwdStrength.textContent = 'strength: ' + strength(fPassword.value); 
        }); 
      }
      
      applyPwdMode();

      // ===== TABLE INTERACTIONS =====
      const filter = document.getElementById('filter');
      const table = document.getElementById('empTable');
      const tbody = table ? table.querySelector('tbody') : null;
      const rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];

      const chips = Array.from(document.querySelectorAll('.chip'));
      let activeRole = 'ALL';
      
      function applyFilters(){
        const q = (filter && filter.value ? filter.value : '').toLowerCase();
        let visible = 0;
        
        for(let i = 0; i < rows.length; i++){
          const r = rows[i];
          const text = r.textContent || r.innerText || '';
          const textHit = String(text).toLowerCase().includes(q);
          const role = (r.getAttribute('data-role') || '').toUpperCase();
          const roleHit = (activeRole === 'ALL' || role === activeRole);
          const show = textHit && roleHit;
          
          r.style.display = show ? '' : 'none';
          if(show) visible++;
        }
        
        updateMobileList();
        paginate.refresh(visible);
      }
      
      for(let c = 0; c < chips.length; c++){
        chips[c].addEventListener('click', function(){
          chips.forEach(ch => ch.classList.remove('active'));
          this.classList.add('active');
          activeRole = this.getAttribute('data-chip');
          applyFilters();
        });
      }
      
      if(filter) filter.addEventListener('input', applyFilters);

      // Sorting
      const ths = table ? table.querySelectorAll('th') : [];
      for(let t = 0; t < ths.length; t++){
        let asc = true;
        
        ths[t].addEventListener('click', function(){
          const type = this.getAttribute('data-sort') || 'text';
          const idx = t;
          
          const get = tr => tr.children[idx].textContent.trim();
          
          const parseDate = s => {
            if(!s || typeof s !== 'string') return new Date(0);
            const parts = s.trim().split(/\s+/);
            const dpart = (parts[0] || '').split('-');
            if(dpart.length < 3) return new Date(0);
            
            const Y = parseInt(dpart[0], 10) || 0;
            const M = (parseInt(dpart[1], 10) || 1) - 1;
            const D = parseInt(dpart[2], 10) || 1;
            let hh = 0, mm = 0, ss = 0;
            
            if(parts[1]){
              const tparts = parts[1].split(':');
              hh = parseInt(tparts[0], 10) || 0;
              mm = parseInt(tparts[1], 10) || 0;
              ss = parseInt(tparts[2], 10) || 0;
            }
            
            return new Date(Y, M, D, hh, mm, ss);
          };
          
          rows.sort((a, b) => {
            if(type === 'date'){
              const da = parseDate(get(a));
              const db = parseDate(get(b));
              return (da - db) * (asc ? 1 : -1);
            }
            
            return get(a).localeCompare(get(b), undefined, {numeric: true, sensitivity: 'base'}) * (asc ? 1 : -1);
          });
          
          for(let i = 0; i < rows.length; i++){ 
            tbody.appendChild(rows[i]); 
          }
          
          asc = !asc;
          updateMobileList();
          applyFilters();
          paginate.refresh();
        });
      }

      // Charts
      function roleCounts(){
        const c = {};
        for(let i = 0; i < rows.length; i++){
          const role = (rows[i].getAttribute('data-role') || '').toUpperCase();
          if(!role) continue;
          c[role] = (c[role] || 0) + 1;
        }
        return c;
      }
      
      (function(){
        const ctx = document.getElementById('rolesChart');
        if(!ctx || !window.Chart) return;
        
        const data = roleCounts();
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(data),
            datasets: [{
              data: Object.values(data),
              backgroundColor: [
                '#3b82f6', '#8b5cf6', '#06b6d4', '#f59e0b', '#ef4444', '#10b981'
              ],
              borderWidth: 0
            }]
          },
          options: {
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  color: getComputedStyle(document.body).getPropertyValue('--text-secondary')
                }
              }
            },
            cutout: '55%'
          }
        });
      })();
      
      (function(){
        const ctx = document.getElementById('hiresChart');
        if(!ctx || !window.Chart) return;
        
        function hiresLastMonths(n){
          n = n || 6;
          const map = new Map();
          const today = new Date(); 
          today.setDate(1);
          
          for(let i = n - 1; i >= 0; i--){
            const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
            map.set(d.toISOString().slice(0, 7), 0);
          }
          
          for(let r = 0; r < rows.length; r++){
            const ym = rows[r].getAttribute('data-created');
            if(ym && map.has(ym)) map.set(ym, map.get(ym) + 1);
          }
          
          return {
            labels: Array.from(map.keys()).map(m => {
              const [year, month] = m.split('-');
              return new Date(year, month - 1).toLocaleString('default', { month: 'short', year: '2-digit' });
            }),
            data: Array.from(map.values())
          };
        }
        
        const hd = hiresLastMonths(6);
        const accentPrimary = getComputedStyle(document.body).getPropertyValue('--accent-primary');
        
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: hd.labels,
            datasets: [{
              label: 'New Hires',
              data: hd.data,
              tension: 0.4,
              fill: true,
              backgroundColor: ctx => {
                const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 250);
                gradient.addColorStop(0, `${accentPrimary}20`);
                gradient.addColorStop(1, `${accentPrimary}02`);
                return gradient;
              },
              borderColor: accentPrimary,
              pointBackgroundColor: accentPrimary,
              pointBorderColor: '#fff',
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                },
                grid: {
                  color: getComputedStyle(document.body).getPropertyValue('--border-light')
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      })();

      // Column visibility
      const colMenu = document.getElementById('colMenu');
      const dd = colMenu ? colMenu.querySelector('.dropdown') : null;
      const colButton = colMenu ? colMenu.querySelector('button') : null;
      
      if(colButton && dd){
        colButton.addEventListener('click', e => {
          e.stopPropagation();
          dd.classList.toggle('open');
        });
        
        document.addEventListener('click', e => {
          if(dd && colMenu && !colMenu.contains(e.target)) {
            dd.classList.remove('open');
          }
        });
        
        const checks = dd.querySelectorAll('input[type="checkbox"]');
        for(let k = 0; k < checks.length; k++){
          checks[k].addEventListener('change', function(){
            const i = parseInt(this.getAttribute('data-col'), 10) - 1;
            const show = this.checked;
            const all = document.querySelectorAll('#empTable tr');
            
            for(let m = 0; m < all.length; m++){
              const cell = all[m].children[i];
              if(cell) cell.style.display = show ? '' : 'none';
            }
            
            updateMobileList();
          });
        }
      }

      // CSV export
      function csvEscape(s){ 
        s = String(s == null ? '' : s); 
        return '"' + s.replace(/"/g, '""').trim() + '"'; 
      }
      
      function download(name, text){
        const a = document.createElement('a');
        a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(text);
        a.download = name; 
        document.body.appendChild(a); 
        a.click(); 
        document.body.removeChild(a);
      }
      
      function tableToCsv(){
        const headCells = Array.from(document.querySelectorAll('#empTable thead th'));
        const firstRow = document.querySelector('#empTable tbody tr');
        const visibility = headCells.map((th, i) => {
          const shown = !(firstRow && firstRow.children[i] && firstRow.children[i].style.display === 'none');
          return { i, title: th.textContent.trim(), shown };
        });
        
        const headers = visibility.filter(c => c.shown !== false).map(c => c.title).join(',');
        const lines = [headers];
        const visibleRows = rows.filter(r => r.style.display !== 'none');
        
        for(let i = 0; i < visibleRows.length; i++){
          const cells = Array.from(visibleRows[i].cells).filter((td, ii) => 
            visibility[ii] && visibility[ii].shown !== false
          );
          
          const cols = cells.map(td => csvEscape(td.textContent));
          lines.push(cols.join(','));
        }
        
        return lines.join('\n');
      }
      
      const exportBtn = document.getElementById('exportCsv');
      if(exportBtn){ 
        exportBtn.addEventListener('click', () => { 
          download('employees.csv', tableToCsv()); 
        }); 
      }

      // Pagination
      const pageInfo = document.getElementById('pageInfo');
      const rowsInfo = document.getElementById('rowsInfo');
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      const pageSizeSel = document.getElementById('pageSize');
      
      const paginate = {
        page: 1,
        size: (pageSizeSel ? Number(pageSizeSel.value) : 50) || 50,
        total: rows.length,
        
        apply() {
          const visible = rows.filter(r => r.style.display !== 'none');
          this.total = visible.length;
          const pages = Math.max(1, Math.ceil(this.total / this.size));
          
          if(this.page > pages) this.page = pages;
          
          for(let i = 0; i < visible.length; i++){
            const start = (this.page - 1) * this.size;
            const end = this.page * this.size;
            visible[i].style.display = (i >= start && i < end) ? '' : 'none';
          }
          
          if(pageInfo) pageInfo.textContent = this.page + ' / ' + Math.max(1, pages);
          if(rowsInfo) rowsInfo.textContent = this.total + ' row(s)';
        },
        
        refresh(count) {
          if(typeof count === 'number') this.total = count;
          this.apply();
        }
      };
      
      if(prevBtn){ 
        prevBtn.addEventListener('click', () => { 
          paginate.page = Math.max(1, paginate.page - 1); 
          paginate.apply(); 
        }); 
      }
      
      if(nextBtn){ 
        nextBtn.addEventListener('click', () => { 
          const pages = Math.max(1, Math.ceil(paginate.total / paginate.size)); 
          paginate.page = Math.min(pages, paginate.page + 1); 
          paginate.apply(); 
        }); 
      }
      
      if(pageSizeSel){ 
        pageSizeSel.addEventListener('change', () => { 
          paginate.size = Number(pageSizeSel.value) || 50; 
          paginate.page = 1; 
          paginate.apply(); 
        }); 
      }

      // Mobile mirror
      const mobileList = document.getElementById('mobileList');
      
      function updateMobileList(){
        if(!mobileList) return;
        mobileList.innerHTML = '';
        
        const vis = rows.filter(r => r.style.display !== 'none');
        for(let i = 0; i < vis.length; i++){
          const r = vis[i];
          const c = r.cells;
          
          const card = document.createElement('div');
          card.className = 'list-card';
          card.innerHTML = `
            <div class="row">
              <strong>${c[0].textContent}</strong>
              <span class="tag">${c[2].textContent}</span>
            </div>
            <div class="row">
              <span>${c[1].textContent}</span>
            </div>
            <div class="row">
              <span>${c[3].textContent} • ${c[4].textContent}</span>
              <span class="muted">${c[5].textContent}</span>
            </div>
            <div class="row">${c[6] ? c[6].innerHTML : ''}</div>
          `;
          
          mobileList.appendChild(card);
        }
      }

      // Attendance export
      const attendance = {% if attendance_logs is defined %}{{ attendance_logs|tojson|safe }}{% else %}[]{% endif %};
      const btnAtt = document.getElementById('btnExportAttendance');
      
      if(btnAtt){
        btnAtt.addEventListener('click', function(){
          const dateEl = document.getElementById('attDate');
          const d = dateEl ? dateEl.value : '';
          
          if(!d){ 
            alert('Please pick a date'); 
            return; 
          }
          
          const day = attendance.filter(x => String(x.date || '').slice(0, 10) === d);
          if(day.length === 0){ 
            alert('No logs for selected date.'); 
            return; 
          }
          
          const headers = ['Name', 'Email', 'Check In', 'Check Out', 'Status', 'Location'];
          const lines = [headers.join(',')];
          
          for(let i = 0; i < day.length; i++){
            const r = day[i];
            const row = [
              r.name || '', 
              r.email || '', 
              r.check_in || '', 
              r.check_out || '', 
              r.status || '', 
              r.location || ''
            ].map(v => csvEscape(v));
            
            lines.push(row.join(','));
          }
          
          download('attendance_' + d + '.csv', lines.join('\n'));
        });
      }

      // Initialize
      const yr = document.getElementById('yr'); 
      if(yr) yr.textContent = new Date().getFullYear();
      
      const allChip = document.querySelector('.chip[data-chip="ALL"]'); 
      if(allChip) allChip.classList.add('active');
      
      applyFilters(); 
      paginate.apply(); 
      updateMobileList();

      // Add subtle animations to cards on scroll
      const observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.1
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.style.animation = 'fadeIn 0.6s ease-out forwards';
            observer.unobserve(entry.target);
          }
        });
      }, observerOptions);

      document.querySelectorAll('.card, .kpi').forEach(el => {
        el.style.opacity = '0';
        observer.observe(el);
      });
    });
  </script>
</body>
</html>